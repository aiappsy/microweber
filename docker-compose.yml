version: "3.9"

services:
  php-apache:
    image: thecodingmachine/php:8.2-v4-apache-node18
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      mariadb:
        condition: service_healthy

    environment:
      # Serve Microweber/Laravel from /public
      APACHE_DOCUMENT_ROOT: /var/www/html/public

      COMPOSER_ALLOW_SUPERUSER: "1"
      PHP_INI_MEMORY_LIMIT: "1024M"
      PHP_INI_ERROR_REPORTING: "E_ALL"

      # (Optional) common extensions; harmless if some already enabled in the image
      PHP_EXTENSIONS: "pdo_mysql mysqli gd intl mbstring zip curl dom exif fileinfo soap xml bcmath opcache"

      # DB (defaults work even when Coolify injects empty vars)
      DB_HOST: mariadb
      DB_PORT: "3306"
      DB_DATABASE: "${MYSQL_DATABASE:-microweber}"
      DB_USERNAME: "${MYSQL_USER:-microweber}"
      DB_PASSWORD: "${MYSQL_PASSWORD:-microweber_pass}"

      # App URL (Coolify sets SERVICE_URL_PHP_APACHE)
      APP_URL: "${SERVICE_URL_PHP_APACHE:-http://localhost}"
      APP_ENV: "production"
      APP_DEBUG: "false"

    volumes:
      # Mount the entire repo
      - ./:/var/www/html:rw

      # Persist writable dirs across deploys
      - microweber_storage:/var/www/html/storage
      - microweber_userfiles:/var/www/html/userfiles

    command: >
      bash -lc "
      set -e;
      cd /var/www/html;

      # Ensure env exists (Microweber/Laravel style)
      if [ ! -f .env ] && [ -f .env.example ]; then cp .env.example .env; fi;

      # Install PHP deps if project has composer.json
      if [ -f composer.json ]; then
        composer install --no-interaction --prefer-dist --optimize-autoloader;
      fi

      # Ensure writable dirs exist and perms are ok
      mkdir -p storage userfiles bootstrap/cache;
      chown -R www-data:www-data storage userfiles bootstrap/cache || true;
      chmod -R 775 storage userfiles bootstrap/cache || true;

      apache2-foreground
      "

  mariadb:
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD:-microweber_root}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-microweber}"
      MYSQL_USER: "${MYSQL_USER:-microweber}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-microweber_pass}"
    volumes:
      - mw-db:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s
      retries: 30

volumes:
  mw-db:
  microweber_storage:
  microweber_userfiles:
