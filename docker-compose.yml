version: "3.9"

services:
  php-apache:
    image: thecodingmachine/php:8.2-v4-apache-node18
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      mariadb:
        condition: service_healthy
    environment:
      # IMPORTANT: this repo has /public at ROOT (not /src/public)
      APACHE_DOCUMENT_ROOT: /var/www/html/public

      COMPOSER_ALLOW_SUPERUSER: "1"
      PHP_INI_MEMORY_LIMIT: "1024M"
      PHP_INI_ERROR_REPORTING: "E_ALL"

      APP_ENV: "production"
      APP_DEBUG: "false"
      APP_URL: "${SERVICE_URL_PHP_APACHE:-http://localhost}"

      DB_CONNECTION: "mysql"
      DB_HOST: "mariadb"
      DB_PORT: "3306"
      DB_DATABASE: "${MYSQL_DATABASE:-microweber}"
      DB_USERNAME: "${MYSQL_USER:-microweber}"
      DB_PASSWORD: "${MYSQL_PASSWORD:-microweber_pass}"

    volumes:
      # Mount the WHOLE repo (so /public exists)
      - ./:/var/www/html:rw

      # Persist writable dirs across deploys
      - microweber_storage:/var/www/html/storage
      - microweber_userfiles:/var/www/html/userfiles

    command: >
      bash -lc "
      set -e;
      cd /var/www/html;

      # Create a minimal Laravel .env if missing (Microweber installer can extend it later)
      if [ ! -f .env ]; then
        cat > .env << 'EOF'
APP_NAME=Microweber
APP_ENV=production
APP_KEY=
APP_DEBUG=false
APP_URL=${APP_URL}

DB_CONNECTION=mysql
DB_HOST=${DB_HOST}
DB_PORT=${DB_PORT}
DB_DATABASE=${DB_DATABASE}
DB_USERNAME=${DB_USERNAME}
DB_PASSWORD=${DB_PASSWORD}
EOF
      fi

      composer install --no-interaction --prefer-dist --optimize-autoloader;

      php artisan key:generate --force || true;
      php artisan storage:link || true;

      mkdir -p storage userfiles bootstrap/cache;
      chown -R www-data:www-data storage userfiles bootstrap/cache || true;
      chmod -R 775 storage userfiles bootstrap/cache || true;

      apache2-foreground
      "

  mariadb:
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD:-microweber_root}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-microweber}"
      MYSQL_USER: "${MYSQL_USER:-microweber}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-microweber_pass}"
    volumes:
      - mw-db:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s
      retries: 30

volumes:
  mw-db:
  microweber_storage:
  microweber_userfiles:
