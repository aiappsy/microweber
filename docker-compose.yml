version: "3.8"

services:
  php-apache:
    image: thecodingmachine/php:8.2-v4-apache-node18
    restart: unless-stopped
    user: root
    depends_on:
      - mariadb

    environment:
      # Apache must serve /public (Laravel)
      APACHE_DOCUMENT_ROOT: /var/www/html/public

      COMPOSER_ALLOW_SUPERUSER: "1"
      PHP_INI_MEMORY_LIMIT: "1024M"
      PHP_INI_ERROR_REPORTING: "E_ALL"

      # Extensions Microweber typically needs
      PHP_EXTENSIONS: "pdo_mysql mysqli gd intl mbstring zip curl dom exif fileinfo soap xml xmlrpc bcmath opcache"

      # App config
      APP_ENV: "production"
      APP_DEBUG: "false"
      APP_URL: "${SERVICE_URL_PHP_APACHE}"

      DB_CONNECTION: "mysql"
      DB_HOST: "mariadb"
      DB_PORT: "3306"
      DB_DATABASE: "${MYSQL_DATABASE}"
      DB_USERNAME: "${MYSQL_USER}"
      DB_PASSWORD: "${MYSQL_PASSWORD}"

    volumes:
      # Your repo into the container
      - ./:/var/www/html:rw

      # Persist these across deploys
      - microweber_storage:/var/www/html/storage
      - microweber_userfiles:/var/www/html/userfiles

    command: >
      bash -lc "
      set -e;
      cd /var/www/html;

      if [ ! -f .env ]; then cp .env.example .env || true; fi;

      composer install --no-interaction --prefer-dist --optimize-autoloader;

      php artisan key:generate --force || true;
      php artisan storage:link || true;

      chown -R www-data:www-data storage bootstrap/cache userfiles || true;
      chmod -R 775 storage bootstrap/cache userfiles || true;

      apache2-foreground
      "

  mariadb:
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
    volumes:
      - mariadb_data:/var/lib/mysql

volumes:
  mariadb_data:
  microweber_storage:
  microweber_userfiles:
