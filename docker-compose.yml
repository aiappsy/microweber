version: "3.9"

services:
  php-apache:
    image: thecodingmachine/php:8.2-v4-apache-node18
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      mariadb:
        condition: service_healthy

    environment:
      APACHE_DOCUMENT_ROOT: /var/www/html
      COMPOSER_ALLOW_SUPERUSER: "1"
      PHP_INI_MEMORY_LIMIT: "1024M"
      PHP_INI_ERROR_REPORTING: "E_ALL"

      DB_HOST: mariadb
      DB_PORT: "3306"
      DB_DATABASE: "${MYSQL_DATABASE:-microweber}"
      DB_USERNAME: "${MYSQL_USER:-microweber}"
      DB_PASSWORD: "${MYSQL_PASSWORD:-microweber_pass}"

      APP_URL: "${SERVICE_URL_PHP_APACHE:-http://localhost}"

    volumes:
      # IMPORTANT: serve the actual app directory (not the repo root)
      - ./src:/var/www/html:rw

      # persistent writable dirs
      - microweber_storage:/var/www/html/storage
      - microweber_userfiles:/var/www/html/userfiles

    command: >
      bash -lc "
      set -e;
      cd /var/www/html;

      if [ -f composer.json ]; then
        composer install --no-interaction --prefer-dist --optimize-autoloader;
      fi

      mkdir -p /var/www/html/storage /var/www/html/userfiles;

      chown -R www-data:www-data /var/www/html/storage /var/www/html/userfiles || true;
      chmod -R 775 /var/www/html/storage /var/www/html/userfiles || true;

      apache2-foreground
      "

  mariadb:
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD:-microweber_root}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-microweber}"
      MYSQL_USER: "${MYSQL_USER:-microweber}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-microweber_pass}"
    volumes:
      - mw-db:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s
      retries: 30

volumes:
  mw-db:
  microweber_storage:
  microweber_userfiles:
